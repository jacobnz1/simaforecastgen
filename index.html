<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMA Forecast Generator</title>
    <!-- Tailwind CSS for Layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Weather Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- html2canvas for downloading -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* GRAPHIC STYLING - MIMICKING US TV STYLE */
        :root {
            --tv-red: #c8102e;
            --tv-blue-grad-start: #2c5282;
            --tv-blue-grad-end: #1a365d;
            --tv-gray: #e2e8f0;
            --tv-dark: #1f2937;
        }

        body { font-family: 'Roboto', sans-serif; background: #111; color: white; }

        #capture-area {
            width: 1280px;
            height: 720px;
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); /* Sky Background */
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Top Bar */
        .top-bar {
            background: white;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            border-bottom: 4px solid var(--tv-red);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 20;
        }

        .logo-img { height: 80px; object-fit: contain; }
        
        .title-text {
            font-family: 'Oswald', sans-serif;
            font-size: 60px;
            font-weight: 700;
            text-transform: uppercase;
            color: black;
            letter-spacing: 2px;
        }

        .branding-text {
            font-family: 'Oswald', sans-serif;
            color: var(--tv-red);
            font-size: 32px;
            font-weight: bold;
        }

        /* The Grid */
        .forecast-grid {
            display: flex;
            flex: 1;
            height: 100%;
        }

        .day-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.3);
            position: relative;
            background: rgba(44, 82, 130, 0.85); /* The blue backing */
            backdrop-filter: blur(5px);
        }

        .day-column:last-child { border-right: none; }

        /* Row 1: Day Name */
        .day-header {
            background: var(--tv-red);
            color: white;
            font-family: 'Oswald', sans-serif;
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            padding: 10px 0;
            box-shadow: inset 0 -2px 5px rgba(0,0,0,0.2);
        }

        /* Row 2: Icon */
        .icon-area {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .weather-icon {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4));
            font-size: 80px; /* Fallback size */
            width: 100px;
            height: 100px;
        }

        /* Row 3: Description / Note */
        .desc-area {
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-family: 'Oswald', sans-serif;
            font-weight: bold;
            font-size: 24px;
            color: white;
            text-shadow: 1px 1px 2px black;
            padding: 0 5px;
            line-height: 1.1;
            text-transform: uppercase;
        }

        /* Row 4: Chance of Rain */
        .pop-area {
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Roboto', sans-serif;
            font-weight: 900;
            font-size: 28px;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        /* Row 5: High Temp (White Box) */
        .high-temp-area {
            background: rgba(255,255,255,0.9);
            flex: 1.5;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            font-family: 'Oswald', sans-serif;
            font-size: 70px;
            font-weight: 700;
            border-top: 1px solid #999;
        }

        /* Row 6: Low Temp (Bottom Bar) */
        .low-temp-area {
            background: #1a202c; /* Dark footer */
            height: 60px; /* Mimic the bottom number bar */
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: 'Oswald', sans-serif;
            font-size: 35px;
            font-weight: 700;
            border-top: 4px solid var(--tv-red); /* The accent line */
        }
        
        /* Bottom Branding Strip */
        .bottom-branding {
            position: absolute;
            bottom: 60px; /* Above the low temp bar */
            left: 0; right: 0;
            height: 0px; 
        }
        
        /* Floating bottom bar overlay logic like the reference image? 
           Actually the reference has the Low Temp separate. We will stick to the column layout.
        */

        .sima-branding {
            position: absolute;
            bottom: 70px;
            left: 10px;
            background: var(--tv-red);
            color: white;
            padding: 5px 15px;
            font-family: 'Oswald', sans-serif;
            font-weight: bold;
            font-size: 18px;
            z-index: 10;
        }

        /* Input Styles */
        input, select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 4px;
            width: 100%;
            font-size: 12px;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- LEFT PANEL: CONTROLS -->
    <div class="w-full md:w-1/3 bg-gray-900 p-4 overflow-y-auto border-r border-gray-700 custom-scroll">
        <h2 class="text-2xl font-bold text-red-500 mb-4 font-oswald uppercase">Simulated Weather AI Control</h2>
        
        <!-- Global Settings -->
        <div class="bg-gray-800 p-3 rounded mb-4">
            <label class="block text-xs uppercase text-gray-400 mb-1">Auto-Fill City (South Island)</label>
            <div class="flex gap-2">
                <input type="text" id="cityInput" placeholder="e.g. Queenstown" class="p-2 rounded text-sm">
                <button onclick="fetchWeatherData()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold">Search</button>
            </div>
            <p id="loadingMsg" class="text-xs text-yellow-400 mt-2 hidden">Contacting meteorological satellites...</p>
        </div>

        <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-bold">Day-by-Day Editor</h3>
            <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-sm font-bold">Download Graphic</button>
        </div>

        <!-- Dynamic Form Container -->
        <div id="controls-container" class="space-y-4">
            <!-- JavaScript will populate 7 days of controls here -->
        </div>
    </div>

    <!-- RIGHT PANEL: PREVIEW -->
    <div class="w-full md:w-2/3 bg-gray-800 flex items-center justify-center p-4 overflow-auto">
        
        <!-- THE GRAPHIC (CANVAS) -->
        <div id="capture-area">
            
            <!-- Top Bar -->
            <div class="top-bar">
                <img src="https://i.imgur.com/vHq4c6t.png" alt="Logo" class="logo-img">
                <div class="title-text">7 DAY PLANNER</div>
                <div class="branding-text">sima.co.nz</div>
            </div>

            <!-- The 7 Columns -->
            <div class="forecast-grid" id="graphic-grid">
                <!-- JavaScript renders columns here -->
            </div>

        </div>
    </div>

    <script>
        // State for the 7 days
        const daysData = Array.from({ length: 7 }, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() + i);
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            return {
                day: days[date.getDay()],
                icon: 'sun',
                desc: 'Sunny',
                pop: '',
                high: 20 + i,
                low: 10 + i
            };
        });

        // Icon Map for Dropdown and API
        const iconMap = {
            'sun': { src: 'https://cdn-icons-png.flaticon.com/512/869/869869.png', label: 'Sunny' },
            'partly-cloudy': { src: 'https://cdn-icons-png.flaticon.com/512/1163/1163624.png', label: 'Partly Cloudy' },
            'cloudy': { src: 'https://cdn-icons-png.flaticon.com/512/414/414825.png', label: 'Cloudy' },
            'rain': { src: 'https://cdn-icons-png.flaticon.com/512/1163/1163657.png', label: 'Rain' },
            'storm': { src: 'https://cdn-icons-png.flaticon.com/512/1146/1146860.png', label: 'Storm' },
            'snow': { src: 'https://cdn-icons-png.flaticon.com/512/642/642102.png', label: 'Snow' },
            'wind': { src: 'https://cdn-icons-png.flaticon.com/512/959/959711.png', label: 'Windy' },
            'fog': { src: 'https://cdn-icons-png.flaticon.com/512/4005/4005901.png', label: 'Fog' }
        };

        // Initialize
        function init() {
            renderControls();
            renderGraphic();
        }

        // Render the Edit Inputs
        function renderControls() {
            const container = document.getElementById('controls-container');
            container.innerHTML = '';

            daysData.forEach((data, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-3 rounded border border-gray-700';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <input type="text" value="${data.day}" class="font-bold w-12 text-center bg-red-900" oninput="updateData(${index}, 'day', this.value)">
                        <select onchange="updateData(${index}, 'icon', this.value)" class="w-32">
                            ${Object.keys(iconMap).map(key => `<option value="${key}" ${data.icon === key ? 'selected' : ''}>${iconMap[key].label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" value="${data.desc}" placeholder="Condition" oninput="updateData(${index}, 'desc', this.value)">
                        <input type="text" value="${data.pop}" placeholder="Rain % / Acc." oninput="updateData(${index}, 'pop', this.value)">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex items-center gap-1"><span class="text-xs text-red-400">H</span> <input type="number" value="${data.high}" oninput="updateData(${index}, 'high', this.value)"></div>
                        <div class="flex items-center gap-1"><span class="text-xs text-blue-400">L</span> <input type="number" value="${data.low}" oninput="updateData(${index}, 'low', this.value)"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Render the TV Graphic
        function renderGraphic() {
            const grid = document.getElementById('graphic-grid');
            grid.innerHTML = '';

            daysData.forEach((data) => {
                const col = document.createElement('div');
                col.className = 'day-column';
                col.innerHTML = `
                    <div class="day-header">${data.day}</div>
                    <div class="icon-area">
                        <img src="${iconMap[data.icon].src}" class="weather-icon">
                    </div>
                    <div class="desc-area">${data.desc}</div>
                    <div class="pop-area">${data.pop}</div>
                    <div class="high-temp-area">${data.high}°</div>
                    <div class="low-temp-area">${data.low}°</div>
                `;
                grid.appendChild(col);
            });
        }

        // Update State
        window.updateData = function(index, field, value) {
            daysData[index][field] = value;
            renderGraphic(); // Re-render graphic, don't re-render controls to keep focus
        }

        // --- FETCH REAL DATA (Simulating Google Weather AI via Open-Meteo) ---
        async function fetchWeatherData() {
            const city = document.getElementById('cityInput').value;
            if(!city) return alert("Please enter a city.");

            const loader = document.getElementById('loadingMsg');
            loader.style.display = 'block';

            try {
                // 1. Geocoding
                const geoReq = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=en&format=json`);
                const geoRes = await geoReq.json();

                if(!geoRes.results) throw new Error("City not found");
                
                const { latitude, longitude, name } = geoRes.results[0];

                // 2. Weather Data
                const weatherReq = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=auto`);
                const weatherRes = await weatherReq.json();
                
                const daily = weatherRes.daily;
                const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

                // Update State
                for(let i=0; i<7; i++) {
                    const date = new Date(daily.time[i]);
                    daysData[i].day = days[date.getDay()];
                    daysData[i].high = Math.round(daily.temperature_2m_max[i]);
                    daysData[i].low = Math.round(daily.temperature_2m_min[i]);
                    
                    // Rain Chance
                    const prob = daily.precipitation_probability_max[i];
                    daysData[i].pop = prob > 20 ? `${prob}%` : '';

                    // Map WMO Codes to our Icons & Text
                    const code = daily.weathercode[i];
                    const condition = mapWmoCode(code);
                    daysData[i].icon = condition.icon;
                    daysData[i].desc = condition.desc;
                }

                renderControls();
                renderGraphic();

            } catch (err) {
                alert("Could not fetch weather data. " + err.message);
            } finally {
                loader.style.display = 'none';
            }
        }

        // Helper: Map WMO codes to our simplified set
        function mapWmoCode(code) {
            // WMO Weather interpretation codes (https://open-meteo.com/en/docs)
            if (code === 0) return { icon: 'sun', desc: 'Sunny' };
            if (code >= 1 && code <= 3) return { icon: 'partly-cloudy', desc: 'Clouds' };
            if (code === 45 || code === 48) return { icon: 'fog', desc: 'Foggy' };
            if (code >= 51 && code <= 55) return { icon: 'rain', desc: 'Drizzle' };
            if (code >= 61 && code <= 65) return { icon: 'rain', desc: 'Rain' };
            if (code >= 80 && code <= 82) return { icon: 'rain', desc: 'Showers' };
            if (code >= 71 && code <= 77) return { icon: 'snow', desc: 'Snow' };
            if (code >= 85 && code <= 86) return { icon: 'snow', desc: 'Snow' };
            if (code >= 95) return { icon: 'storm', desc: 'Storm' };
            return { icon: 'cloudy', desc: 'Cloudy' };
        }

        // Download Function
        window.downloadImage = function() {
            const captureArea = document.getElementById('capture-area');
            html2canvas(captureArea, { scale: 1 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'SIMA_Forecast.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        init();
    </script>
</body>
</html>
